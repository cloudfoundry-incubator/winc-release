filter timestamp {"$(Get-Date -Format G): $_"}

$ErrorActionPreference = "Stop";
trap { $host.SetShouldExit(1) }

Write-Output "Started groot pre-start" | timestamp

$grootDriverStore = "<%= p("groot.driver_store") %>"
$refreshAllLayers=[bool]$<%= p("groot.refresh_all_layers") %>

# TODO: change mutex to semaphore
$mtx = New-Object System.Threading.Mutex($false, "RootfsMutex")
$thirtyMinutes = 30 * 60 * 1000

<% p("groot.cached_image_uris").each do |uri| %>
  Write-Output "Acquiring RootfsMutex" | timestamp
  if (!$mtx.WaitOne($thirtyMinutes)) {
    throw "Could not acquire RootfsMutex after 30 minutes"
  }
  Write-Output "Acquired RootfsMutex" | timestamp

  # We used to include this as a workaround for https://github.com/Microsoft/hcsshim/issues/155,
  # but it turns out this is still required - if there are containers existing
  # when bosh does a restart, the garden server would fail to come up because there is still a
  # process using the old garden-init.exe
  Get-ComputeProcess | foreach { c:\var\vcap\packages\winc\winc.exe delete $_.Id }

  # TODO: document moving this - it should be protected by the mutex, and also
  # it makes sense to delete containers BEFORE trying to clean up any remaining volumes.
  if(Test-Path "$grootDriverStore\volumes"){
    ls "$grootDriverStore\volumes" | foreach { c:\var\vcap\packages\groot\groot.exe --driver-store $grootDriverStore delete $_.Name }
  }

  if($refreshAllLayers){
    Write-Output "Refreshing groot layers" | timestamp
    # TODO: decide what to call the command, maybe clean? See https://github.com/cloudfoundry/grootfs/blob/master/commands/clean.go
    # C:\var\vcap\packages\groot\groot.exe --config "C:\var\vcap\jobs\groot\config\groot.yml" --driver-store $grootDriverStore clean
  }

  Write-Output "Begin pulling <%= uri %> image" | timestamp
  C:\var\vcap\packages\groot\groot.exe --config "C:\var\vcap\jobs\groot\config\groot.yml" --driver-store $grootDriverStore pull <%= uri %>
  if ($LASTEXITCODE -ne 0) {
    $mtx.ReleaseMutex()
    Write-Output "Released RootfsMutex" | timestamp
    exit $LASTEXITCODE
  }
  Write-Output "Finished pulling <%= uri %> image" | timestamp

  $mtx.ReleaseMutex()
  Write-Output "Released RootfsMutex" | timestamp
<% end %>

Write-Output "Finished groot pre-start" | timestamp
